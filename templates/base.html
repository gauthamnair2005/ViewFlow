<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViewFlow - {{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">
    {% if config.VIDEOJS_LOCAL %}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/video-js.css') }}">
    {% else %}
    <link rel="stylesheet" href="https://vjs.zencdn.net/8.20.0/video-js.css">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=0.7.4">
</head>
<body class="ms-Fabric theme-dark">
    <nav class="navbar">
        <a href="{{ url_for('main.home') }}" class="logo"><img src="{{ url_for('static', filename='logo.svg') }}" alt="ViewFlow Logo" class="logo-icon"><span>View<span>Flow</span></span></a>
        <form action="{{ url_for('main.search') }}" method="GET" class="search-form">
            <input type="text" name="q" id="search-input" placeholder="Search" class="search-input">
            <button type="button" id="voice-search-btn" class="icon-btn" title="Search by voice">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <button type="submit" class="icon-btn search-btn" title="Search">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </button>
        </form>
        <div class="nav-links">
            <button id="theme-toggle" title="Toggle theme" class="btn" style="margin-right:8px; display:flex; align-items:center; justify-content:center;"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg></button>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.upload') }}" class="btn btn-accent">+ Upload</a>
                <span>{{ current_user.display_name or current_user.username }}</span>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Logout</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary">Sign In</a>
            {% endif %}
        </div>
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
    <footer>
        <p>Developed by <strong>Gautham Nair</strong> & <strong>Deepak Patel</strong></p>
        <p>&copy; 2025 View<span>Flow</span> Project <span style="color: var(--text-sec); font-size: 0.85rem;">v0.7.2</span></p>
    </footer>
    {% if config.VIDEOJS_LOCAL %}
    <script src="{{ url_for('static', filename='vendor/video.min.js') }}"></script>
    {% else %}
    <script src="https://vjs.zencdn.net/8.20.0/video.min.js"></script>
    {% endif %}
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='player.js') }}"></script>
    <script src="{{ url_for('static', filename='async_actions.js') }}?v=0.7.2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const voiceBtn = document.getElementById('voice-search-btn');
            const searchInput = document.getElementById('search-input');
            let mediaRecorder = null;
            let audioChunks = [];
            let isRecording = false;

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                voiceBtn.addEventListener('click', async function() {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                if(voiceBtn) voiceBtn.style.display = 'none';
            }

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToBackend(audioBlob);
                        
                        // Stop all tracks to release mic
                        stream.getTracks().forEach(track => track.stop());
                    });

                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.classList.add('listening');
                    searchInput.value = '';
                    searchInput.setAttribute('placeholder', 'Listening... (Click to stop)');
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    showError("Mic access denied");
                }
            }

            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    voiceBtn.classList.remove('listening');
                    searchInput.setAttribute('placeholder', 'Processing...');
                }
            }

            function sendAudioToBackend(blob) {
                const formData = new FormData();
                formData.append('audio', blob, 'recording.webm');

                fetch("{{ url_for('main.voice_search_api') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const data = await response.json();
                        if (data.text) {
                            searchInput.value = data.text;
                            searchInput.form.submit();
                        } else if (data.error) {
                            showError(data.error);
                        }
                    } else {
                        console.error("Server returned non-JSON response:", response.status);
                        showError("Server Error: " + response.status);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError("Network/Server Error");
                })
                .finally(() => {
                    if (searchInput.getAttribute('placeholder') === 'Processing...') {
                        searchInput.setAttribute('placeholder', 'Search');
                    }
                });
            }

            function showError(msg) {
                searchInput.value = '';
                searchInput.setAttribute('placeholder', msg);
                voiceBtn.classList.remove('listening');
                setTimeout(() => {
                    searchInput.setAttribute('placeholder', 'Search');
                }, 3000);
            }
        });
    </script>
</body>
</html>
