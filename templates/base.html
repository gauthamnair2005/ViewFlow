<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViewFlow - {{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">
    {% if config.VIDEOJS_LOCAL %}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/video-js.css') }}">
    {% else %}
    <link rel="stylesheet" href="https://vjs.zencdn.net/8.20.0/video-js.css">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=0.8.5">
    <style>
        .upload-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border: 2px solid var(--bg-main);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .upload-tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-sec);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            width: 200px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-top: 10px;
        }
        .upload-tooltip.show {
            display: block;
        }
        .upload-item {
            font-size: 0.85rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .confirm-box {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            animation: modalPop 0.2s forwards;
        }
        @keyframes modalPop {
            to { transform: scale(1); }
        }
        .confirm-box h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-main);
        }
        .confirm-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
    </style>
</head>
<body class="ms-Fabric theme-dark">
    <nav class="navbar">
        <a href="{{ url_for('main.home') }}" class="logo"><img src="{{ url_for('static', filename='logo.svg') }}" alt="ViewFlow Logo" class="logo-icon"><span>View<span>Flow</span></span></a>
        <form action="{{ url_for('main.search') }}" method="GET" class="search-form" style="position: relative;">
            <input type="text" name="q" id="search-input" placeholder="Search" class="search-input" autocomplete="off">
            <div id="search-suggestions" class="search-suggestions"></div>
            <button type="button" id="voice-search-btn" class="icon-btn" title="Search by voice">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <button type="submit" class="icon-btn search-btn" title="Search">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </button>
        </form>
        <div class="nav-links">
            <button id="theme-toggle" title="Toggle theme" class="btn" style="margin-right:8px; display:flex; align-items:center; justify-content:center;"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg></button>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.upload') }}" class="btn btn-accent nav-btn" title="Upload">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                </a>
                <a href="{{ url_for('main.notifications') }}" class="btn nav-btn" style="background: transparent;" title="Notifications">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                </a>
                <a href="{{ url_for('main.subscriptions') }}" class="btn nav-btn" style="background: transparent;" title="Subscriptions">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                </a>
                <a href="{{ url_for('main.settings') }}" class="btn nav-btn" style="background: transparent;" title="Settings">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.41l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.41l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                </a>
                <a href="{{ url_for('main.user_profile', username=current_user.username) }}" class="nav-profile-link" title="Profile">
                    {% if current_user.profile_pic %}
                    <img src="{{ url_for('main.uploaded_file', filename=current_user.profile_pic) }}" alt="{{ current_user.username }}" class="nav-avatar">
                    {% else %}
                    <div class="nav-avatar-placeholder">{{ current_user.username[0].upper() }}</div>
                    {% endif %}
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-primary nav-btn" title="Logout">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                </a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary">Sign In</a>
            {% endif %}
        </div>
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-box">
            <h3 id="confirm-message">Are you sure?</h3>
            <div class="confirm-actions">
                <button class="btn" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-accent" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
    <footer>
        <p>Developed by <strong>Gautham Nair</strong> & <strong>Deepak Patel</strong></p>
        <p>&copy; 2025 View<span>Flow</span> Project <span style="color: var(--text-sec); font-size: 0.85rem;">v0.9.0</span></p>
    </footer>
    {% if config.VIDEOJS_LOCAL %}
    <script src="{{ url_for('static', filename='vendor/video.min.js') }}"></script>
    {% else %}
    <script src="https://vjs.zencdn.net/8.20.0/video.min.js"></script>
    {% endif %}
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='player.js') }}"></script>
    <script src="{{ url_for('static', filename='async_actions.js') }}?v=0.7.2"></script>
    <script>
        let pendingForm = null;

        function openConfirmModal(event, message) {
            event.preventDefault();
            pendingForm = event.target;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-modal').style.display = 'flex';
            return false;
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingForm = null;
        }

        function confirmAction() {
            if (pendingForm) {
                pendingForm.submit();
            }
            closeConfirmModal();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const voiceBtn = document.getElementById('voice-search-btn');
            const searchInput = document.getElementById('search-input');
            let mediaRecorder = null;
            let audioChunks = [];
            let isRecording = false;
            const suggestionsBox = document.getElementById('search-suggestions');

            // Search Suggestions Logic
            if (searchInput && suggestionsBox) {
                const fetchSuggestions = (query) => {
                    fetch(`{{ url_for('main.search_suggestions') }}?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            suggestionsBox.innerHTML = '';
                            if (data.length > 0) {
                                suggestionsBox.style.display = 'block';
                                data.forEach(item => {
                                    const div = document.createElement('div');
                                    div.className = 'suggestion-item';
                                    div.innerHTML = `
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 12px; color: var(--text-sec); min-width: 16px;">
                                            ${item.type === 'trending' ? '<path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>' : '<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>'}
                                        </svg>
                                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.text}</span>
                                    `;
                                    div.addEventListener('click', () => {
                                        searchInput.value = item.text;
                                        suggestionsBox.style.display = 'none';
                                        searchInput.form.submit();
                                    });
                                    suggestionsBox.appendChild(div);
                                });
                            } else {
                                suggestionsBox.style.display = 'none';
                            }
                        })
                        .catch(err => console.error('Error fetching suggestions:', err));
                };

                searchInput.addEventListener('input', function() {
                    fetchSuggestions(this.value);
                });

                searchInput.addEventListener('focus', function() {
                    fetchSuggestions(this.value);
                });

                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                        suggestionsBox.style.display = 'none';
                    }
                });
            }

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                voiceBtn.addEventListener('click', async function() {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                if(voiceBtn) voiceBtn.style.display = 'none';
            }

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToBackend(audioBlob);
                        
                        // Stop all tracks to release mic
                        stream.getTracks().forEach(track => track.stop());
                    });

                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.classList.add('listening');
                    searchInput.value = '';
                    searchInput.setAttribute('placeholder', 'Listening... (Click to stop)');
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    showError("Mic access denied");
                }
            }

            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    voiceBtn.classList.remove('listening');
                    searchInput.setAttribute('placeholder', 'Processing...');
                }
            }

            function sendAudioToBackend(blob) {
                const formData = new FormData();
                formData.append('audio', blob, 'recording.webm');

                fetch("{{ url_for('main.voice_search_api') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const data = await response.json();
                        if (data.text) {
                            searchInput.value = data.text;
                            searchInput.form.submit();
                        } else if (data.error) {
                            showError(data.error);
                        }
                    } else {
                        console.error("Server returned non-JSON response:", response.status);
                        showError("Server Error: " + response.status);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError("Network/Server Error");
                })
                .finally(() => {
                    if (searchInput.getAttribute('placeholder') === 'Processing...') {
                        searchInput.setAttribute('placeholder', 'Search');
                    }
                });
            }

            function showError(msg) {
                searchInput.value = '';
                searchInput.setAttribute('placeholder', msg);
                voiceBtn.classList.remove('listening');
                setTimeout(() => {
                    searchInput.setAttribute('placeholder', 'Search');
                }, 3000);
            }

            // Upload Progress Logic
            const profileLink = document.querySelector('.nav-profile-link');
            if (profileLink) {
                const badge = document.createElement('div');
                badge.className = 'upload-badge';
                badge.style.display = 'none';
                profileLink.style.position = 'relative';
                profileLink.appendChild(badge);

                const tooltip = document.createElement('div');
                tooltip.className = 'upload-tooltip';
                profileLink.appendChild(tooltip);

                let isHovering = false;
                profileLink.addEventListener('mouseenter', () => { isHovering = true; updateTooltip(); });
                profileLink.addEventListener('mouseleave', () => { isHovering = false; tooltip.classList.remove('show'); });

                let processingVideos = [];

                function updateTooltip() {
                    if (processingVideos.length > 0 && isHovering) {
                        tooltip.innerHTML = '<div style="font-weight:bold; margin-bottom:5px; color:var(--text-main)">Processing Uploads</div>';
                        processingVideos.forEach(v => {
                            tooltip.innerHTML += `<div class="upload-item">â†» ${v.title}</div>`;
                        });
                        tooltip.classList.add('show');
                    } else {
                        tooltip.classList.remove('show');
                    }
                }

                function checkUploads() {
                    fetch('/api/upload_status')
                        .then(res => {
                            if(res.ok) return res.json();
                            return {processing: []};
                        })
                        .then(data => {
                            processingVideos = data.processing || [];
                            if (processingVideos.length > 0) {
                                badge.style.display = 'block';
                                updateTooltip();
                            } else {
                                badge.style.display = 'none';
                                tooltip.classList.remove('show');
                            }
                        })
                        .catch(err => console.log('Upload status check failed', err));
                }

                setInterval(checkUploads, 5000);
                checkUploads();
            }
        });
    </script>
</body>
</html>
